<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Study Mode - MCQ Quiz</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Theme Variables */
    :root {
      --bg-gradient-start: #0f172a;
      --bg-gradient-mid: #1e1b4b;
      --bg-gradient-end: #3b0764;
      --text-color: #ffffff;
      --card-bg: rgba(0, 0, 0, 0.4);
      --card-border: rgba(139, 92, 246, 0.3);
      --banner-bg: rgba(0, 0, 0, 0.5);
      --option-bg: rgba(0, 0, 0, 0.3);
      --option-hover-bg: rgba(139, 92, 246, 0.2);
      --option-selected-bg: rgba(139, 92, 246, 0.5);
      --option-selected-border: rgba(139, 92, 246, 1);
      --option-marker-bg: #4b5563;
      --option-marker-selected-bg: #8b5cf6;
      --option-correct-bg: rgba(16, 185, 129, 0.3);
      --option-correct-border: rgba(16, 185, 129, 0.8);
      --option-incorrect-bg: rgba(239, 68, 68, 0.3);
      --option-incorrect-border: rgba(239, 68, 68, 0.8);
      --option-marker-correct-bg: #10b981;
      --option-marker-incorrect-bg: #ef4444;
      --accent-color: #a855f7;
      --accent-gradient-start: #22d3ee;
      --accent-gradient-end: #a855f7;
      --dialog-bg: #1f2937;
      --btn-primary-bg: #7c3aed;
      --btn-primary-border: #8b5cf6;
      --btn-primary-hover: #8b5cf6;
      --btn-secondary-bg: #374151;
      --btn-secondary-border: #4b5563;
      --btn-secondary-hover: #4b5563;
      --scrollbar-track: rgba(0, 0, 0, 0.2);
      --scrollbar-thumb: rgba(139, 92, 246, 0.5);
      --scrollbar-thumb-hover: rgba(139, 92, 246, 0.8);
      --muted-text: #9ca3af;
      --explanation-bg: rgba(0, 0, 0, 0.3);
      --explanation-title: #a855f7;
      --card-header-bg: rgba(30, 41, 59, 0.8);
      --card-header-collapsed-bg: rgba(30, 41, 59, 0.5);
    }

    /* Light Theme */
    [data-theme="light"] {
      --bg-gradient-start: #f0f9ff;
      --bg-gradient-mid: #e0f2fe;
      --bg-gradient-end: #dbeafe;
      --text-color: #1e293b;
      --card-bg: rgba(255, 255, 255, 0.7);
      --card-border: rgba(139, 92, 246, 0.3);
      --banner-bg: rgba(255, 255, 255, 0.8);
      --option-bg: rgba(255, 255, 255, 0.7);
      --option-hover-bg: rgba(139, 92, 246, 0.1);
      --option-selected-bg: rgba(139, 92, 246, 0.2);
      --option-selected-border: rgba(139, 92, 246, 0.8);
      --option-marker-bg: #d1d5db;
      --option-marker-selected-bg: #8b5cf6;
      --option-correct-bg: rgba(16, 185, 129, 0.15);
      --option-correct-border: rgba(16, 185, 129, 0.6);
      --option-incorrect-bg: rgba(239, 68, 68, 0.15);
      --option-incorrect-border: rgba(239, 68, 68, 0.6);
      --option-marker-correct-bg: #10b981;
      --option-marker-incorrect-bg: #ef4444;
      --accent-color: #8b5cf6;
      --accent-gradient-start: #06b6d4;
      --accent-gradient-end: #8b5cf6;
      --dialog-bg: #ffffff;
      --btn-primary-bg: #8b5cf6;
      --btn-primary-border: #7c3aed;
      --btn-primary-hover: #7c3aed;
      --btn-secondary-bg: #e5e7eb;
      --btn-secondary-border: #d1d5db;
      --btn-secondary-hover: #d1d5db;
      --scrollbar-track: rgba(0, 0, 0, 0.05);
      --scrollbar-thumb: rgba(139, 92, 246, 0.3);
      --scrollbar-thumb-hover: rgba(139, 92, 246, 0.5);
      --muted-text: #6b7280;
      --explanation-bg: rgba(226, 232, 240, 0.7);
      --explanation-title: #8b5cf6;
      --card-header-bg: rgba(226, 232, 240, 0.8);
      --card-header-collapsed-bg: rgba(226, 232, 240, 0.5);
    }

    /* Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-mid), var(--bg-gradient-end));
      color: var(--text-color);
      min-height: 100vh;
      padding-bottom: 40px;
      transition: background 0.3s ease;
    }

    /* Typography */
    h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    /* Layout */
    .container {
      width: 95%;
      max-width: 95vw;
      margin: 0 auto;
      padding: 1rem;
      padding-top: 70px; /* Added padding to account for the fixed top banner */
    }

    /* Card Styles */
    .card {
      background-color: var(--card-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      margin-bottom: 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease, border 0.3s ease;
      overflow: hidden;
    }

    .card-header {
      background-color: var(--card-header-bg);
      padding: 1rem 1.5rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s ease;
      border-bottom: 1px solid var(--card-border);
    }

    .card-header.collapsed {
      background-color: var(--card-header-collapsed-bg);
      border-bottom: none;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
    }

    .card-header .question-number {
      background: linear-gradient(to right, var(--accent-gradient-start), var(--accent-gradient-end));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-right: 0.5rem;
      font-weight: bold;
    }

    .card-header .toggle-icon {
      transition: transform 0.3s ease;
    }

    .card-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .card-body {
      padding: 1.5rem;
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .card-body.collapsed {
      max-height: 0;
      padding: 0 1.5rem;
    }

    /* Banner Styles */
    .banner {
      position: fixed;
      width: 100%;
      left: 0;
      top: 0;
      padding: 0.75rem 1rem;
      background-color: var(--banner-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      border-bottom: 1px solid var(--card-border);
      transition: background-color 0.3s ease, border 0.3s ease;
    }

    .banner-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    /* Button Styles */
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      border: 1px solid var(--card-border);
      background-color: transparent;
      color: var(--text-color);
      white-space: nowrap;
    }

    .btn:hover {
      background-color: var(--option-hover-bg);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn i {
      margin-right: 0.5rem;
    }

    /* Theme Toggle */
    .theme-toggle {
      padding: 0.4rem;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: transparent;
      border: 1px solid var(--card-border);
      color: var(--text-color);
      transition: all 0.2s ease;
      width: 38px;
      height: 38px;
      flex-shrink: 0;
    }

    .theme-toggle:hover {
      background-color: var(--option-hover-bg);
    }

    /* Options */
    .option {
      padding: 1rem;
      margin: 0.75rem 0;
      border-radius: 8px;
      background-color: var(--option-bg);
      border: 1px solid var(--card-border);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
    }

    .option.correct {
      background-color: var(--option-correct-bg);
      border-color: var(--option-correct-border);
    }

    .option-marker {
      width: 24px;
      height: 24px;
      min-width: 24px; /* Prevent shrinking */
      min-height: 24px; /* Prevent shrinking */
      border-radius: 50%;
      background-color: var(--option-marker-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      font-size: 0.75rem;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }

    .option.correct .option-marker {
      background-color: var(--option-marker-correct-bg);
    }

    /* Explanation Box */
    .explanation-box {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
      background-color: var(--explanation-bg);
      border: 1px solid var(--card-border);
      transition: background-color 0.3s ease, border 0.3s ease;
    }

    .explanation-box h3 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      color: var(--explanation-title);
    }

    /* Controls */
    .controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 0.75rem;
      background-color: var(--banner-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      border-top: 1px solid var(--card-border);
    }

    .controls-inner {
      display: flex;
      gap: 1rem;
      max-width: 1000px;
      width: 100%;
      justify-content: space-between;
      align-items: center;
    }

    /* Utility classes */
    .hidden {
      display: none;
    }

    /* Gradient Text */
    .gradient-text {
      background: linear-gradient(to right, var(--accent-gradient-start), var(--accent-gradient-end));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--scrollbar-thumb-hover);
    }

    /* Expand/Collapse All button */
    .expand-collapse-btn {
      margin-left: auto;
      margin-right: 0.5rem;
    }

    /* Add this to the style section */
    .topic-header {
      background: linear-gradient(to right, var(--accent-gradient-start), var(--accent-gradient-end));
      color: white;
      padding: 0.5rem 1rem;
      font-weight: 500;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      margin-bottom: -1px;
    }

    /* Topic Selector Styling */
    #topicSelector {
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--card-border);
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1em;
      padding-right: 2rem;
      min-width: 120px;
    }

    #topicSelector option {
      background-color: var(--dialog-bg);
      color: var(--text-color);
    }

    /* MCQ Navigator Modal */
    .mcq-navigator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      z-index: 2000;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .mcq-navigator.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mcq-navigator-content {
      background-color: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .mcq-navigator-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--card-border);
    }

    .mcq-navigator-close {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }

    .mcq-navigator-close:hover {
      background-color: var(--option-hover-bg);
    }

    .mcq-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    .mcq-item {
      background-color: var(--option-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mcq-item:hover {
      background-color: var(--option-hover-bg);
      border-color: var(--accent-color);
    }

    .mcq-item-number {
      font-weight: bold;
      color: var(--accent-color);
      margin-bottom: 0.5rem;
    }

    .mcq-item-preview {
      font-size: 0.9rem;
      line-height: 1.4;
      color: var(--muted-text);
    }

    /* Scroll Position Indicator */
    .scroll-indicator {
      position: fixed;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      background-color: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 0.5rem;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      max-width: 200px;
    }

    .scroll-indicator.visible {
      opacity: 1;
      visibility: visible;
    }

    .scroll-indicator-content {
      font-size: 0.8rem;
      text-align: center;
    }

    .scroll-indicator-number {
      font-weight: bold;
      color: var(--accent-color);
      margin-bottom: 0.25rem;
    }

    .scroll-indicator-preview {
      color: var(--muted-text);
      line-height: 1.3;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .banner {
        padding: 0.5rem;
        flex-direction: column;
        gap: 0.5rem;
        height: auto;
        min-height: 60px;
      }

      .banner-controls {
        width: 100%;
        justify-content: space-between;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 0.25rem;
      }

      .container {
        padding-top: 80px; /* Increased for mobile banner height */
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }

      .card-header {
        padding: 0.75rem 1rem;
      }

      .card-body {
        padding: 1rem;
      }

      .option {
        padding: 0.75rem;
      }

      .btn {
        padding: 0.4rem 0.75rem;
        font-size: 0.875rem;
      }

      .btn i {
        margin-right: 0.25rem;
      }

      /* Hide text on small buttons for mobile */
      .expand-collapse-btn .btn-text,
      .home-btn .btn-text,
      .mcq-nav-btn .btn-text {
        display: none;
      }

      .expand-collapse-btn,
      .home-btn,
      .mcq-nav-btn {
        margin: 0;
      }

      .btn i {
        margin-right: 0;
      }

      #topicSelector {
        min-width: 100px;
        font-size: 0.875rem;
        padding: 0.4rem 1.5rem 0.4rem 0.5rem;
      }

      .controls-inner {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
      }

      /* Ensure option markers stay circular */
      .option-marker {
        width: 24px;
        height: 24px;
        min-width: 24px;
        min-height: 24px;
        flex-shrink: 0;
      }

      h2 {
        font-size: 1.25rem;
      }

      .card-header h2 {
        font-size: 1.1rem;
        line-height: 1.3;
      }

      .mcq-list {
        grid-template-columns: 1fr;
      }

      .scroll-indicator {
        right: 0.5rem;
        max-width: 150px;
      }
    }

    @media (max-width: 480px) {
      .banner {
        padding: 0.25rem;
      }

      .banner-controls {
        gap: 0.125rem;
      }

      .container {
        padding-top: 90px;
        padding-left: 0.25rem;
        padding-right: 0.25rem;
      }

      .btn {
        padding: 0.3rem 0.5rem;
        font-size: 0.8rem;
      }

      .theme-toggle {
        width: 32px;
        height: 32px;
        padding: 0.3rem;
      }

      #topicSelector {
        min-width: 80px;
        font-size: 0.8rem;
        padding: 0.3rem 1.2rem 0.3rem 0.4rem;
      }

      .card-header h2 {
        font-size: 1rem;
      }

      .option {
        padding: 0.5rem;
      }

      .option-marker {
        width: 20px;
        height: 20px;
        min-width: 20px;
        min-height: 20px;
        font-size: 0.7rem;
        margin-right: 0.75rem;
      }

      .mcq-navigator-content {
        padding: 1rem;
        max-width: 95vw;
      }

      .scroll-indicator {
        right: 0.25rem;
        max-width: 120px;
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <div class="banner">
    <div style="font-weight: 500;">Study Mode</div>
    <div class="banner-controls">
      <select id="topicSelector" class="btn">
        <option value="all">All Topics</option>
        <!-- Topics will be populated here -->
      </select>
      <button class="btn mcq-nav-btn" id="mcqNavBtn">
        <i class="fas fa-list"></i> <span class="btn-text">MCQ List</span>
      </button>
      <button class="btn expand-collapse-btn" id="expandCollapseBtn">
        <i class="fas fa-expand-alt"></i> <span class="btn-text">Expand All</span>
      </button>
      <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
      </button>
      <button class="btn home-btn" id="homeBtn">
        <i class="fas fa-home"></i> <span class="btn-text">Home</span>
      </button>
    </div>
  </div>

  <!-- MCQ Navigator Modal -->
  <div class="mcq-navigator" id="mcqNavigator">
    <div class="mcq-navigator-content">
      <div class="mcq-navigator-header">
        <h3>MCQ Navigator</h3>
        <button class="mcq-navigator-close" id="mcqNavigatorClose">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="mcq-list" id="mcqList">
        <!-- MCQ list items will be populated here -->
      </div>
    </div>
  </div>

  <!-- Scroll Position Indicator -->
  <div class="scroll-indicator" id="scrollIndicator">
    <div class="scroll-indicator-content">
      <div class="scroll-indicator-number" id="scrollIndicatorNumber">Q1</div>
      <div class="scroll-indicator-preview" id="scrollIndicatorPreview">Loading...</div>
    </div>
  </div>

  <div class="container" id="studyContainer">
    <!-- Study content will be rendered here -->
    <div class="loading-message">
      <p>Loading questions...</p>
    </div>
  </div>

  <div class="controls">
    <div class="controls-inner">
      <button class="btn" id="scrollTopBtn">
        <i class="fas fa-arrow-up"></i> Back to Top
      </button>
      <span id="questionCounter">0 Questions Loaded</span>
      <button class="btn" id="scrollBottomBtn">
        <i class="fas fa-arrow-down"></i> Go to Bottom
      </button>
    </div>
  </div>

  <script>
    // DOM Elements
    const studyContainer = document.getElementById('studyContainer');
    const themeToggle = document.getElementById('themeToggle');
    const homeBtn = document.getElementById('homeBtn');
    const scrollTopBtn = document.getElementById('scrollTopBtn');
    const scrollBottomBtn = document.getElementById('scrollBottomBtn');
    const questionCounter = document.getElementById('questionCounter');
    const expandCollapseBtn = document.getElementById('expandCollapseBtn');
    const mcqNavBtn = document.getElementById('mcqNavBtn');
    const mcqNavigator = document.getElementById('mcqNavigator');
    const mcqNavigatorClose = document.getElementById('mcqNavigatorClose');
    const mcqList = document.getElementById('mcqList');
    const scrollIndicator = document.getElementById('scrollIndicator');
    const scrollIndicatorNumber = document.getElementById('scrollIndicatorNumber');
    const scrollIndicatorPreview = document.getElementById('scrollIndicatorPreview');

    // State variables
    let mcqs = [];
    let allExpanded = true;
    let allTopics = null;
    let filteredMcqs = [];
    let scrollTimeout;

    // Theme Toggle
    themeToggle.addEventListener('click', () => {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      
      // Update theme toggle icon
      const themeIcon = themeToggle.querySelector('i');
      if (newTheme === 'dark') {
        themeIcon.className = 'fas fa-moon';
      } else {
        themeIcon.className = 'fas fa-sun';
      }
      
      // Save theme preference
      localStorage.setItem('theme', newTheme);
    });

    // Load saved theme
    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // Update theme toggle icon
        const themeIcon = themeToggle.querySelector('i');
        if (savedTheme === 'dark') {
          themeIcon.className = 'fas fa-moon';
        } else {
          themeIcon.className = 'fas fa-sun';
        }
      }
      
      // Initialize the study mode
      initStudyMode();
    });

    // Home button
    homeBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    // Scroll to top button
    scrollTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Scroll to bottom button
    scrollBottomBtn.addEventListener('click', () => {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });

    // MCQ Navigator
    mcqNavBtn.addEventListener('click', () => {
      populateMcqNavigator();
      mcqNavigator.classList.add('active');
    });

    mcqNavigatorClose.addEventListener('click', () => {
      mcqNavigator.classList.remove('active');
    });

    // Close navigator when clicking outside
    mcqNavigator.addEventListener('click', (e) => {
      if (e.target === mcqNavigator) {
        mcqNavigator.classList.remove('active');
      }
    });

    // Expand/Collapse All button
    expandCollapseBtn.addEventListener('click', () => {
      const cardHeaders = document.querySelectorAll('.card-header');
      const cardBodies = document.querySelectorAll('.card-body');
      
      if (allExpanded) {
        // Collapse all
        cardHeaders.forEach(header => header.classList.add('collapsed'));
        cardBodies.forEach(body => body.classList.add('collapsed'));
        expandCollapseBtn.innerHTML = '<i class="fas fa-expand-alt"></i> <span class="btn-text">Expand All</span>';
      } else {
        // Expand all
        cardHeaders.forEach(header => header.classList.remove('collapsed'));
        cardBodies.forEach(body => body.classList.remove('collapsed'));
        expandCollapseBtn.innerHTML = '<i class="fas fa-compress-alt"></i> <span class="btn-text">Collapse All</span>';
      }
      
      allExpanded = !allExpanded;
    });

    // Scroll position tracking
    window.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      
      // Show scroll indicator
      scrollIndicator.classList.add('visible');
      
      // Update current MCQ in view
      updateScrollIndicator();
      
      // Hide scroll indicator after scrolling stops
      scrollTimeout = setTimeout(() => {
        scrollIndicator.classList.remove('visible');
      }, 2000);
    });

    // Initialize the study mode
    function initStudyMode() {
      fetch('Devi.json')
        .then(res => res.json())
        .then(data => {
          // Check if data has topics structure
          if (data.topics) {
            // New JSON format with topics
            allTopics = data.topics;
            populateTopicSelector(data.topics);
            
            // Initially load all questions from all topics
            mcqs = [];
            data.topics.forEach(topic => {
              mcqs = mcqs.concat(topic.mcqs);
            });
          } else {
            // Old JSON format without topics
            mcqs = data;
            allTopics = null;
          }
          
          renderStudyCards();
          questionCounter.textContent = `${mcqs.length} Questions Loaded`;
          
          // Load saved state after initializing
          loadState();
        })
        .catch(err => {
          studyContainer.innerHTML = '<p>Error loading study questions.</p>';
          console.error(err);
        });
    }

    // Populate topic selector dropdown
    function populateTopicSelector(topics) {
      const topicSelector = document.getElementById('topicSelector');
      
      // Clear existing options except "All Topics"
      while (topicSelector.options.length > 1) {
        topicSelector.remove(1);
      }
      
      // Add topics to selector
      topics.forEach((topic, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = topic.topic;
        topicSelector.appendChild(option);
      });
      
      // Add event listener for topic selection
      topicSelector.addEventListener('change', function() {
        const selectedValue = this.value;
        
        if (selectedValue === 'all') {
          // Load all questions from all topics
          mcqs = [];
          topics.forEach(topic => {
            mcqs = mcqs.concat(topic.mcqs);
          });
        } else {
          // Load questions from selected topic
          const topicIndex = parseInt(selectedValue);
          mcqs = topics[topicIndex].mcqs;
        }
        
        renderStudyCards();
        questionCounter.textContent = `${mcqs.length} Questions Loaded`;
      });
    }

    // Populate MCQ Navigator
    function populateMcqNavigator() {
      let html = '';
      
      mcqs.forEach((mcq, index) => {
        const question = mcq.question || mcq.statement || '';
        const preview = question.length > 80 ? question.substring(0, 80) + '...' : question;
        
        html += `
          <div class="mcq-item" data-mcq-index="${index}">
            <div class="mcq-item-number">Question ${index + 1}</div>
            <div class="mcq-item-preview">${preview}</div>
          </div>
        `;
      });
      
      mcqList.innerHTML = html;
      
      // Add click listeners to MCQ items
      document.querySelectorAll('.mcq-item').forEach(item => {
        item.addEventListener('click', () => {
          const mcqIndex = parseInt(item.dataset.mcqIndex);
          navigateToMcq(mcqIndex);
          mcqNavigator.classList.remove('active');
        });
      });
    }

    // Navigate to specific MCQ
    function navigateToMcq(index) {
      const cards = document.querySelectorAll('#studyContainer > .card');
      if (cards[index]) {
        // Expand the card if collapsed
        const cardHeader = cards[index].querySelector('.card-header');
        const cardBody = cards[index].querySelector('.card-body');
        
        if (cardHeader && cardHeader.classList.contains('collapsed')) {
          cardHeader.classList.remove('collapsed');
          cardBody.classList.remove('collapsed');
        }
        
        // Scroll to the card
        const cardTop = cards[index].offsetTop - 100;
        window.scrollTo({ top: cardTop, behavior: 'smooth' });
        
        // Highlight the card temporarily
        cards[index].style.boxShadow = '0 0 0 3px var(--accent-color)';
        cards[index].style.transform = 'scale(1.02)';
        cards[index].style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
          cards[index].style.boxShadow = '';
          cards[index].style.transform = '';
        }, 2000);
      }
    }

    // Update scroll indicator
    function updateScrollIndicator() {
      const cards = document.querySelectorAll('#studyContainer > .card');
      const scrollPosition = window.scrollY + window.innerHeight / 2;
      
      let currentMcqIndex = 0;
      
      cards.forEach((card, index) => {
        const cardTop = card.offsetTop;
        const cardBottom = cardTop + card.offsetHeight;
        
        if (scrollPosition >= cardTop && scrollPosition <= cardBottom) {
          currentMcqIndex = index;
        }
      });
      
      if (mcqs[currentMcqIndex]) {
        const mcq = mcqs[currentMcqIndex];
        const question = mcq.question || mcq.statement || '';
        const preview = question.length > 50 ? question.substring(0, 50) + '...' : question;
        
        scrollIndicatorNumber.textContent = `Q${currentMcqIndex + 1}`;
        scrollIndicatorPreview.textContent = preview;
      }
    }

    // Render all study cards
    function renderStudyCards() {
      let html = '';
      
      mcqs.forEach((mcq, index) => {
        html += createStudyCard(mcq, index);
      });
      
      studyContainer.innerHTML = html;
      
      // Add event listeners to card headers for toggling
      document.querySelectorAll('.card-header').forEach(header => {
        header.addEventListener('click', () => {
          header.classList.toggle('collapsed');
          const body = header.nextElementSibling;
          body.classList.toggle('collapsed');
        });
      });
    }

    // Create a single study card
    function createStudyCard(mcq, index) {
      // Add topic header if available
      let topicHeader = '';
      if (mcq.topic) {
        topicHeader = `<div class="topic-header">${mcq.topic}</div>`;
      }
      
      let cardHtml = `
        <div class="card">
          ${topicHeader}
          <div class="card-header">
            <h2><span class="question-number">${index + 1}.</span> ${mcq.question || mcq.statement}</h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </div>
          <div class="card-body">
            <div class="options">
      `;
      
      // Add options
      const options = mcq.options || [];
      options.forEach((option, i) => {
        const isCorrect = i === mcq.correctIndex || i === mcq.correct_option_index;
        const optionClass = isCorrect ? 'correct' : '';
        
        cardHtml += `
          <div class="option ${optionClass}">
            <div class="option-marker">${String.fromCharCode(65 + i)}</div>
            <div>${option}</div>
          </div>
        `;
      });
      
      cardHtml += `
            </div>
            <div class="explanation-box">
              <h3>Explanation</h3>
              <p>${mcq.explanation}</p>
            </div>
          </div>
        </div>
      `;
      
      return cardHtml;
    }

    // Save current state to localStorage
    function saveState() {
      const state = {
        currentTopic: document.getElementById('topicSelector').value,
        expandedState: allExpanded,
        scrollPosition: window.scrollY
      };
      localStorage.setItem('studyModeState', JSON.stringify(state));
    }

    // Load state from localStorage
    function loadState() {
      const savedState = localStorage.getItem('studyModeState');
      if (savedState) {
        const state = JSON.parse(savedState);
        
        // Set topic selector to saved value
        const topicSelector = document.getElementById('topicSelector');
        if (topicSelector.querySelector(`option[value="${state.currentTopic}"]`)) {
          topicSelector.value = state.currentTopic;
          
          // If a specific topic was selected, load that topic
          if (state.currentTopic !== 'all' && allTopics) {
            const topicIndex = parseInt(state.currentTopic);
            mcqs = allTopics[topicIndex].mcqs;
            renderStudyCards();
            questionCounter.textContent = `${mcqs.length} Questions Loaded`;
          }
        }
        
        // Set expanded state
        allExpanded = state.expandedState;
        if (!allExpanded) {
          expandCollapseBtn.innerHTML = '<i class="fas fa-expand-alt"></i> <span class="btn-text">Expand All</span>';
        } else {
          expandCollapseBtn.innerHTML = '<i class="fas fa-compress-alt"></i> <span class="btn-text">Collapse All</span>';
        }
        
        // Restore scroll position after rendering
        setTimeout(() => {
          window.scrollTo(0, state.scrollPosition);
        }, 100);
      }
    }

    // Add event listeners for state saving
    window.addEventListener('beforeunload', saveState);

    // Modify topic selector event listener to save state
    document.getElementById('topicSelector').addEventListener('change', function() {
      const selectedValue = this.value;
      
      if (selectedValue === 'all') {
        // Load all questions from all topics
        mcqs = [];
        allTopics.forEach(topic => {
          mcqs = mcqs.concat(topic.mcqs);
        });
      } else {
        // Load questions from selected topic
        const topicIndex = parseInt(selectedValue);
        mcqs = allTopics[topicIndex].mcqs;
      }
      
      renderStudyCards();
      questionCounter.textContent = `${mcqs.length} Questions Loaded`;
      saveState();
    });
  </script>
</body>
</html>
